#include "../include/OLED.h"

uint8_t write[129];

// Badgerloop Logo 128x64
static uint8_t buffer[SSD1306_LCDHEIGHT * SSD1306_LCDWIDTH / 8] = {
0x00,0x00,0xFC,0xFE,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,
0x0C,0xFC,0xF8,0x70,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xF0,0x7C,0x1C,0x0E,0x0E,
0x0E,0x3C,0xF8,0xF0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0xFE,0x0E,0x0E,
0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x0C,0x1C,0x7C,0xF8,0xE0,0x00,0x00,
0x00,0xF0,0xF8,0x3C,0x1C,0x0C,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,
0x0E,0x0E,0x0C,0x00,0x00,0x80,0xF0,0xF8,0x1C,0x1C,0x0C,0x0E,0x0E,0x0E,0x0E,0x0E,
0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x00,0x00,0x00,0x00,0xFE,0xFE,0x0E,0x0E,0x0E,
0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x0C,0x1C,0xFC,0xF8,0x00,0x00,0x00,0x00,
0x00,0x00,0xFF,0xFF,0x87,0x83,0x83,0x83,0x83,0x83,0x83,0x83,0x83,0x83,0x83,0x83,
0x87,0xCF,0xFD,0xF8,0x00,0x00,0x80,0xE0,0xFC,0x3F,0x1F,0x19,0x18,0x18,0x18,0x18,
0x18,0x18,0x18,0x1B,0x1F,0x7E,0xF8,0xE0,0x00,0x00,0x00,0x00,0xFF,0xFF,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0xC0,0xF0,0xFF,0x3F,0x00,0x00,
0x00,0x7F,0xFF,0xE0,0xC0,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0xFE,0xFE,0xFE,0x00,0x00,0x0F,0x7F,0xFF,0xC7,0xC7,0x87,0x87,0x87,0x87,0x87,0x87,
0x87,0x87,0x87,0x87,0x87,0x87,0x87,0x00,0x00,0x00,0x00,0xFF,0xFF,0x0C,0x0C,0x0C,
0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0E,0x3F,0xFB,0xF1,0x00,0x00,0x00,0x00,
0x00,0x00,0xF3,0xF3,0xF3,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,
0x01,0x01,0x01,0x00,0x00,0x80,0xC3,0xC3,0xE0,0xE0,0xA0,0xA0,0xB0,0x90,0x90,0x90,
0x80,0x20,0x20,0x20,0x00,0x40,0x01,0x03,0x03,0x20,0x20,0x00,0x03,0x03,0x43,0x43,
0x43,0x43,0x03,0x03,0x83,0x83,0x83,0x83,0x03,0x01,0x01,0x01,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x01,0x01,0x01,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,
0x03,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x03,0x03,0x03,0x03,0x03,
0x03,0x03,0x03,0xF3,0xF3,0xF3,0x73,0x70,0x70,0x70,0x70,0x73,0x73,0x70,0x70,0x70,
0x70,0x70,0x70,0x70,0x70,0x70,0xE0,0xE0,0xC0,0x80,0x03,0x03,0x00,0x00,0x00,0x00,
0x00,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,
0xF0,0xB8,0x8C,0x9A,0x9D,0x9F,0x9F,0xBF,0xBF,0xBF,0x3F,0x3F,0x3F,0x7F,0x7F,0x7F,
0x7F,0x7F,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,
0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0x7C,0xB8,0xD8,0xF8,0xA8,0xD0,0xF0,0xF8,0xF8,
0xF8,0xE4,0xE4,0xE4,0xE4,0xC4,0xC4,0xC4,0xC4,0x80,0x88,0x88,0x00,0x10,0x00,0x20,
0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0xFF,0xFE,0xE0,0x00,0x00,0x00,
0x00,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0xFF,
0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFF,0xFD,0xFD,0xFD,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xDF,0xF7,0xDD,0xF6,0xFB,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xDF,0xDF,
0xDF,0xDF,0xBF,0xBF,0x3F,0x3F,0x37,0x63,0xC3,0x81,0x01,0x01,0x01,0xC1,0x23,0x22,
0x22,0x20,0x64,0x64,0xE0,0xE8,0xD0,0xD0,0xA0,0x00,0x40,0x80,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0xFF,0xFF,0xFF,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,
0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xE0,0xE0,0x78,0x3C,0x1F,0x07,0x00,0x00,0x00,0x00,
0x00,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,
0x0F,0x19,0x71,0xC1,0x81,0x01,0x03,0x03,0x03,0x03,0x03,0x07,0x07,0x07,0x07,0x07,
0x07,0x0F,0x0F,0x0F,0x0F,0x0F,0x1F,0x1F,0x1F,0x1F,0x3F,0x3F,0x3F,0x7B,0x7B,0xFF,
0xF7,0xF7,0x18,0xFF,0x24,0xEF,0xEF,0xEF,0xEF,0xCF,0xDF,0xDF,0xDF,0x9F,0x9F,0xBF,
0xBF,0xBF,0x3F,0x3F,0x7F,0x7F,0x7F,0x7E,0xFE,0xFD,0xFE,0xFC,0xF8,0xF0,0xE2,0xC4,
0x88,0x20,0x40,0x80,0x00,0xC7,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0xFC,0xF9,0xFA,0xF4,
0xE0,0xC8,0xD0,0xBF,0x7F,0xFF,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0xFF,0xFF,0xFF,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,
0xC0,0xC0,0xC0,0xC0,0xC0,0xC1,0xC3,0xC2,0xC6,0x04,0x04,0x0C,0x08,0x08,0x08,0x08,
0x08,0x08,0x04,0x04,0x44,0x42,0x02,0x81,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x03,0x1E,0x33,0xE7,0x8F,0x0F,0x1F,0x3F,0x3F,0x3F,0x7F,0x7F,0x7F,
0x7F,0x7F,0x7F,0xFF,0xFF,0xFF,0xFE,0xFE,0xFE,0xFE,0xFE,0xFD,0xFD,0xF9,0xFB,0xF3,
0xE7,0xE7,0xCE,0x9C,0x19,0x37,0x6F,0xDF,0xB7,0x43,0x03,0x03,0x83,0x87,0x87,0x87,
0x87,0x8F,0x8F,0x9F,0x1F,0x3E,0x3D,0x7A,0x74,0xE8,0xD0,0xC0,0x80,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x00,0x02,0x02,
0x00,0x00,0x04,0x04,0x00,0x00,0x00,0x01,0x03,0x06,0x04,0x08,0x18,0x10,0x30,0x20,
0x20,0x20,0x40,0x40,0x40,0x40,0x40,0x41,0x01,0x21,0x21,0x21,0x03,0x03,0x03,0x03,
0x03,0x07,0x07,0x07,0x07,0x07,0x0E,0x0C,0x0D,0x0B,0x17,0x1F,0x1C,0x18,0x10,0x00,
0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x00,0x02,0x02,0x03,0x03,0x07,0x04,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

bool ssd1306_command(uint8_t data) {
    write[0] = 0x00;
    write[1] = data;
    return I2CwriteAndRead(OLED_ADDR, write, 2, NULL, 0);
}

bool checkLCD(void) { return !ssd1306_command(0xE3); }

void fullscreenImage(void) {
    ssd1306_command(SSD1306_COLUMNADDR);
    ssd1306_command(0);
    ssd1306_command(127);
    
    ssd1306_command(SSD1306_PAGEADDR);
    ssd1306_command(0);
    ssd1306_command(7);
}

void setColumns(uint8_t start, uint8_t end) {
    ssd1306_command(SSD1306_COLUMNADDR);
    ssd1306_command(start);
    ssd1306_command(end);
}

void setPages(uint8_t start, uint8_t end) {
    ssd1306_command(SSD1306_PAGEADDR);
    ssd1306_command(start);
    ssd1306_command(end);
}

bool ssd1306_init(void) {
    if (!checkLCD()) return false;
    
    ssd1306_command(SSD1306_DISPLAYOFF);                    // 0xAE
    ssd1306_command(SSD1306_SETDISPLAYCLOCKDIV);            // 0xD5
    ssd1306_command(0x80);                                  // the suggested ratio 0x80

    ssd1306_command(SSD1306_SETMULTIPLEX);                  // 0xA8
    ssd1306_command(SSD1306_LCDHEIGHT - 1);

    ssd1306_command(SSD1306_SETDISPLAYOFFSET);              // 0xD3
    ssd1306_command(0x0);                                   // no offset
    ssd1306_command(SSD1306_SETSTARTLINE | 0x0);            // line #0
    ssd1306_command(SSD1306_CHARGEPUMP);                    // 0x8D
    ssd1306_command(0x14);

    ssd1306_command(SSD1306_MEMORYMODE);                    // 0x20
    ssd1306_command(0x00);                                  // 0x0 act like ks0108
    ssd1306_command(SSD1306_SEGREMAP | 0x1);
    ssd1306_command(SSD1306_COMSCANDEC);

    ssd1306_command(SSD1306_SETCOMPINS);                    // 0xDA
    ssd1306_command(0x12);
    ssd1306_command(SSD1306_SETCONTRAST);                   // 0x81
    ssd1306_command(0xCF); 

    ssd1306_command(SSD1306_SETPRECHARGE);                  // 0xd9
    ssd1306_command(0xF1);
    ssd1306_command(SSD1306_SETVCOMDETECT);                 // 0xDB
    ssd1306_command(0x40);
    ssd1306_command(SSD1306_DISPLAYALLON_RESUME);           // 0xA4
    ssd1306_command(SSD1306_NORMALDISPLAY);                 // 0xA6

    ssd1306_command(SSD1306_DEACTIVATE_SCROLL);

    ssd1306_command(SSD1306_DISPLAYON);//--turn on oled panel
    
    ssd1306_fillScreen(false);
    return true;
}

void ssd1306_drawSquare(uint8_t x, uint8_t y, uint8_t width, uint8_t height, bool color) {
    int i, j;
    uint8_t startPageIndex, numPages, endPageIndex, endPageIndexMask = 0;
    
    startPageIndex = y % 8;
    endPageIndex = (startPageIndex + height) % 8;
    for (i = 0; i < endPageIndex; i++) endPageIndexMask |= 1 << i;
    
    numPages = (startPageIndex + height) / 8;
    if (endPageIndex % 8 > 0) numPages++;
    
    setColumns(x, x + width - 1);
    setPages(y / 8, (y / 8) + numPages - 1);
    
    write[0] = 0x40;
    for (i = 0; i < numPages; i++) {
        for (j = 0; j < width; j++) {
            if (color) {
                write[j + 1] = 0xff;
                if (i == 0) write[j + 1] = write[j + 1] << startPageIndex;
                if (i == numPages - 1) write[j + 1] &= endPageIndexMask;
            }
            else write[j + 1] = 0x00;
        }
        I2CwriteAndRead(OLED_ADDR, write, width + 1, NULL, 0);
    }
}

void ssd1306_drawLine(uint8_t x, uint8_t y, uint8_t length) {
    int i;
    uint8_t data = 1 << (y % 8);
    setColumns(x, x + length - 1);
    setPages(y / 8, y / 8);
    write[0] = 0x40;
    for (i = 0; i < length; i++) write[i + 1] = data;
    I2CwriteAndRead(OLED_ADDR, write, length + 1, NULL, 0);
}

void ssd1306_fillScreen(bool color) {
    int i, j;
    uint8_t data = color ? 0xff : 0x00;
    fullscreenImage();
    write[0] = 0x40;
    for (i = 0; i < 8; i++) {
        for (j = 0; j < 128; j++) write[j + 1] = data;
        I2CwriteAndRead(OLED_ADDR, write, 129, NULL, 0);
    }
}

void ssd1306_drawBitmap(void) {
    int i, j;
    fullscreenImage();
    write[0] = 0x40;
    for (i = 0; i < 8; i++) {
        for (j = 0; j < 128; j++) write[j + 1] = buffer[i*128 + j];
        I2CwriteAndRead(OLED_ADDR, write, 129, NULL, 0);
    }
}

void ssd1306_drawChar(uint8_t line, uint8_t pos, char c) {
    int i;
    
    if (line > 7 || pos > 20) return;
    
    setColumns(pos * 6, pos * 6 + 6);
    setPages(line, line);
    write[0] = 0x40;
    for (i = 0; i < 5; i++) write[i + 1] = fiveBySevenCharBitmaps[(c - 32)*5 + i];
    write[6] = 0x00;
    I2CwriteAndRead(OLED_ADDR, write, 7, NULL, 0);
}

void ssd1306_print(const char * string, uint8_t line, uint8_t pos) {
    while (*string != '\0') ssd1306_drawChar(line, pos++, *(string++));
}
